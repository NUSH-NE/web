const title=$("pgTitle"),usrAcctBtn=$("usrBtn"),loginDialog=$("loginDialog").MDCDialog,verifyEmailBtn=q("#verEmailMsg button"),readCardsHolder=$("read-cards"),elem=document.querySelector(".mason-cards"),readerDialog=$("readerDialog").MDCDialog,readFixToggle=$("read-sidebar-fixed").MDCIconButtonToggle,readSidebar=q("div.reader-dialog aside.readerAside"),addPostBtn=$("addPostBtn"),fileUploadElem=$("fileUpload"),storageRef=firebase.storage().ref(),fProgressBar=$("file-upload-progress").MDCLinearProgress,postDialog=$("postImgDialog").MDCDialog;let fUI,maxHeight=250;function reCalcTitleAnim(){const e=(title.getBoundingClientRect().top-8)/maxHeight;if(scrollY>=maxHeight-8)return title.style.position="fixed",title.style.left="10px",title.style.top="10px",title.style.right="10px",title.style.zIndex="6",title.style.backgroundColor="rgba(0, 0, 0, .7)",title.style.borderRadius="7px",title.style.minWidth="unset",title.style.fontSize="1.75rem",void(title.style.lineHeight=title.style.fontSize);title.style.position="inherit",title.style.minWidth=`calc(${100*(1-e)}% - 20px)`,title.style.borderRadius=`${20*e+7}px`,title.style.fontSize=`${Math.min(3.75-2*(1-e),3.8)}rem`,title.style.lineHeight=title.style.fontSize,title.style.backgroundColor=`rgba(0, 0, 0, ${.5*(1-e)})`}function reCalcTotalHeight(){maxHeight=title.getBoundingClientRect().top+scrollY+15,reCalcTitleAnim()}function updateUsrInfo(e){q("#usrOps > h2").textContent=`Hello, ${e.displayName}`,q("#usrOps > img.profile-img").src=e.photoURL,$("usrName").textContent=`Name: ${e.displayName} `,$("usrEmail").textContent=`Email: ${e.email} `,$("verEmailMsg").style.display=e.emailVerified?"none":"block"}function showHideUserArea(){if(cUser)return $("usrOps").style.display="block",updateUsrInfo(cUser),!0}function getArticleCard(e,t,i){const a=document.createElement("div");return a.classList.add("mdc-card"),a.innerHTML=`\n<div class="mdc-card__media mdc-card__media--16-9" style="background-image:url('${t}')">\n</div>\n<div class="mdc-card-wrapper__text-section">\n    <div class="mdc-card__text-section-header">${e.title}</div>\n    <div class="mdc-card__text-section-subhead">${e.articleContent}</div>\n</div>\n<div class="mdc-card__actions">\n    <div class="mdc-card__action-buttons">\n        <button class="mdc-button mdc-card__action mdc-card__action--button" data-mdc-auto-init="MDCRipple">\n            <div class="mdc-button__ripple"></div>\n            <span class="mdc-button__label">Read</span>\n        </button>\n    </div>\n    <div class="mdc-card__action-icons">\n        <button class="material-icons mdc-icon-button mdc-card__action mdc-card__action--icon mdc-ripple-surface" data-mdc-ripple-is-unbounded\n                title="Share" data-mdc-auto-init="MDCRipple">\n            share\n        </button>\n        <button class="material-icons mdc-icon-button mdc-card__action mdc-card__action--icon mdc-ripple-surface" data-mdc-ripple-is-unbounded\n                title="More options" data-mdc-auto-init="MDCRipple">\n            more_vert\n        </button>\n    </div>\n</div>\n    `,a.querySelector(".mdc-button.mdc-card__action.mdc-card__action--button").onclick=(()=>{i(e,t)}),a}function showAuthMsg(e){const t=$("authMsg"),i=q("#authMsg > div.mdc-card-wrapper__text-section");q("#authMsg button").onclick=(()=>t.classList.add("hidden")),i.textContent=e,t.classList.remove("hidden")}function showReaderDialog(e,t){const i=$("reader-content-holder"),a=$("readerResLinks");i.textContent="",a.textContent="";const o=document.createElement("img");o.src=t,o.classList.add("readerHeadImg"),i.appendChild(o);const n=document.createElement("div");i.appendChild(n),n.innerHTML=e.articleContent,$("reader-title-elem").textContent=e.title,e.resLinks?e.resLinks.forEach(e=>{const t=document.createElement("li"),i=document.createElement("a");i.textContent=e.length<=50?e:e.slice(50)+"...",i.href=e,t.appendChild(i),a.appendChild(t)}):a.innerHTML+="<p>No resource links</p>",readerDialog.open()}function debounceResize(e){let t;return function(i){t&&clearTimeout(t),t=setTimeout(e,100,i)}}let fAuth=firebase.auth(),throttleScroll=!1;document.addEventListener("scroll",()=>{throttleScroll||(reCalcTitleAnim(),throttleScroll=!0,setTimeout(()=>throttleScroll=!1,30))},{passive:!0}),window.addEventListener("resize",debounceResize(()=>{reCalcTotalHeight(),reCalcTotalHeight()})),new IntersectionObserver(()=>{usrAcctBtn.classList.toggle("hidden-fab")},{threshold:0}).observe($("b")),usrAcctBtn.onclick=(()=>{loginDialog.isOpen?loginDialog.close():(showHideUserArea()||initFUI(),loginDialog.open())}),$("signOutBtn").onclick=(()=>{fAuth.signOut().then(()=>{initFUI()},e=>{showMsg("Error signing out. Please try again later."),console.error(e)})}),verifyEmailBtn.onclick=(()=>{verifyEmailBtn.disabled=!0,cUser.sendEmailVerification().then(function(){showMsg(`Sent a verification email to ${cUser.email}`),showAuthMsg("Reopen this dialog after clicking on the verification link to check your email verification status")}).catch(function(e){showMsg(`Failed to send the verification email. Error: ${e.message}`)})});const db=firebase.firestore();db.collection("articles").onSnapshot(e=>{readCardsHolder.textContent="",0===e.docs.length&&(readCardsHolder.innerHTML="<p>No articles</p>"),e.docs.forEach(e=>{readCardsHolder.appendChild(getArticleCard({articleContent:e.data().content,title:e.data().title,resLinks:e.data().resourceLink},e.data().link,showReaderDialog))}),new Masonry(elem,{itemSelector:".mdc-card",fitWidth:!0,gutter:8}),mdc.autoInit()}),readFixToggle.listen("MDCIconButtonToggle:change",e=>{e.detail.isOn?readSidebar.classList.add("fixed"):readSidebar.classList.remove("fixed")}),addPostBtn.onclick=(()=>{fileUploadElem.click()}),fileUploadElem.onchange=(()=>{if(console.log(fileUploadElem.files[0]),0===fileUploadElem.files.length)return void showMsg("No file selected");if(!fileUploadElem.files[0].type.match(/^image\/.*/))return void showMsg("Selected file is not an image");if(fileUploadElem.files[0].size>2e6)return void showMsg("Image size too big (max 2MB)");const e=new FileReader;e.onload=(e=>{q(".post-dialog img.img-preview").src=e.target.result.toString()}),e.readAsDataURL(fileUploadElem.files[0]),postDialog.open()}),postDialog.listen("MDCDialog:closed",e=>{if("upload"===e.detail.action){const e=storageRef.child("usrImgPosts").child(uuidv4()).put(fileUploadElem.files[0]);addPostBtn.disabled=!0,e.on("state_changed",e=>{fProgressBar.determinate=!0,fProgressBar.progress=e.bytesTransferred/e.totalBytes},e=>{console.error(e),addPostBtn.disabled=!1},()=>{showMsg("Upload completed"),fileUploadElem.value="",e.snapshot.ref.getDownloadURL().then(e=>{console.log({downloadURL:e}),db.collection("usrImgPosts").add({uid:cUser.uid,imgURL:e,caption:$("post-caption").MDCTextField.value}).then(()=>{showMsg("Added post"),addPostBtn.disabled=!1,$("post-caption").MDCTextField.value=""}).catch(e=>{showMsg("Aw, Snap! Error adding post!"+e),addPostBtn.disabled=!1})})})}});const flkty=new Flickity("#postCarousel",{wrapAround:!0,lazyLoad:4,pageDots:!1,friction:.5,selectedAttraction:.1,arrowShape:"M 69.25 12.457031 C 67.207031 10.417969 63.917969 10.417969 61.875 12.457031 L 27.25 47.082031 C 25.625 48.707031 25.625 51.332031 27.25 52.957031 L 61.875 87.582031 C 63.917969 89.625 67.207031 89.625 69.25 87.582031 C 71.292969 85.542969 71.292969 82.25 69.25 80.207031 L 39.082031 50 L 69.292969 19.792969 C 71.292969 17.792969 71.292969 14.457031 69.25 12.457031 Z M 69.25 12.457031"});flkty.next(),flkty.previous(),flkty.nextButton.element.classList.add("mdc-ripple-surface","mdc-elevation--z20"),flkty.nextButton.element.setAttribute("data-mdc-auto-init","MDCRipple"),flkty.prevButton.element.classList.add("mdc-ripple-surface","mdc-elevation--z20"),flkty.prevButton.element.setAttribute("data-mdc-auto-init","MDCRipple"),$("load-articles").MDCLinearProgress.determinate=!1,reCalcTotalHeight(),reCalcTitleAnim(),db.collection("usrImgPosts").onSnapshot(e=>{e.docChanges().forEach(e=>{if("added"===e.type){const t=document.createElement("div");t.setAttribute("data-article-id",e.doc.id),t.innerHTML=`<img data-flickity-lazyload="${e.doc.data().imgURL}" class="mdc-elevation--z16" \n                onerror="this.src='assets/img/broken_image-dark.svg'" draggable="false"/>`,t.classList.add("carousel-cell");const i=document.createElement("div");i.classList.add("content-cover"),i.innerHTML="<h3>Image Caption</h3>";const a=document.createElement("p");a.textContent=e.doc.data().caption,a.classList.add("mdc-typography--body1"),i.appendChild(a),t.appendChild(i),flkty.append(t)}"modified"===e.type&&console.log("Modified: ",e.doc.data()),"removed"===e.type&&flkty.remove(q(`[data-article-id="${e.doc.id}"]`))})});